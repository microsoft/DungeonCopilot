<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>던전앤코파일럿3</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; }
  .container { max-width: 960px; margin: 0 auto; }
    h1 { margin: 0 0 1rem; font-size: 1.6rem; }
    .panel { border: 1px solid #9993; border-radius: 12px; padding: 1.25rem; margin-top: 1rem; }
    label { display: block; margin: .5rem 0 .25rem; font-weight: 600; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: .75rem .9rem; border: 1px solid #9996; border-radius: 10px; font-size: 1rem;
    }
  /* callsign & keycode fields width override */
  #callsign, #keycode { width: 400px; max-width: 100%; }
    button {
      margin-top: .75rem; padding: .3rem .7rem; font-size: 1rem; border-radius: 10px; border: 1px solid #0000;
      background: #2563eb; color: white; cursor: pointer;
    }
    button.secondary { background: #e5e7eb; color: #111827; }
    .row { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    .hint { color: #6b7280; font-size: .95rem; margin-top: .25rem; }
    .status { font-weight: 600; margin: .25rem 0 .75rem; }
    .error { color: #dc2626; margin-top: .5rem; }
    .success { color: #16a34a; margin-top: .5rem; }
    .badge { display: inline-block; padding: .2rem .55rem; border-radius: 999px; font-size: .85rem; background: #e5e7eb; color: #111827; }
    .spacer { height: .5rem; }

    /* Stage image header */
  .stage-hero { background: #fff; padding: 12px 16px; }
    @media (prefers-color-scheme: dark) { .stage-hero { background: #111827; } }
  .stage-hero img { display: block; width: 100%; max-width: 960px; height: auto; margin: 0 auto; }
  /* Stage iframe (local file fallback) */
  .stage-iframe { width: 100%; border: 0; min-height: 320px; background: transparent; }
  /* Center the "vibe" message */
  .vibe { text-align: center; margin-top: 30px; }
  details.fold summary { cursor: pointer; }
	details.fold .fold-body { margin-top: .5rem; }
  </style>
</head>
<body>
  <header class="stage-hero" role="banner">
    <img id="stageImg" src="img/그림1.png" alt="스테이지 이미지" />
  </header>
  <div class="container">
    <div id="app" class="panel"></div>
  </div>

  <script>
    // jQuery fallback loader for file:// or blocked CDN
    function ensureJQuery(then, fail) {
      if (window.jQuery) { then(); return; }
      var alt = document.createElement('script');
      alt.src = 'https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js';
      alt.onload = function(){ then(); };
      alt.onerror = function(){ if (fail) fail(); };
      document.head.appendChild(alt);
    }

    // --- Cookie helpers ---
    function setCookie(name, value, days) {
      var expires = "";
      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
    }
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
      }
      return null;
    }
    function eraseCookie(name) {
      document.cookie = name + "=; Max-Age=-1; path=/";
    }

    // --- App state ---
    var KEYCODES = { 1: "1111", 2: "2222", 3: "3333", 4: "4444", 5: "5555", 6: "6666" };

    // --- Stage image header helpers ---
    // NOTE: 이미지 파일은 모두 `img/` 폴더에 있으므로 리스트와 반환값에 `img/` 접두사를 추가합니다.
    var STAGE_IMG_LIST = [
      "img/그림1.png",
      "img/그림2.png",
      "img/그림3.png",
      "img/그림4.png",
      "img/그림5.png",
      "img/그림6.png",
      "img/그림7.png"
    ];
    // Preload images to minimize flicker
    (function preloadStageImages(){
      for (var i = 0; i < STAGE_IMG_LIST.length; i++) {
        var im = new Image(); im.src = STAGE_IMG_LIST[i];
      }
    })();
    function getStageImage(stage) {
      if (stage === "complete") return "img/그림6.png";
      var n = parseInt(stage, 10);
      if (isNaN(n) || n <= 0) return "img/그림0.png"; // Stage0 default
      if (n >= 1 && n <= 6) return "img/그림" + n + ".png";
      return "img/그림1.png";
    }
    function updateStageHero(stage) {
      var imgEl = document.getElementById('stageImg');
      if (!imgEl) return;
      var src = getStageImage(stage);
      if (imgEl.getAttribute('src') !== src) {
        imgEl.src = src;
      }
      // Optional: alt text for accessibility
      if (stage === 'complete') {
        imgEl.alt = '완료 스테이지 이미지';
      } else {
        var n2 = parseInt(stage, 10) || 0;
        imgEl.alt = (n2 === 0 ? '시작 스테이지 이미지' : ('스테이지 ' + n2 + ' 이미지'));
      }
    }

    // --- External HTML loader for stage fragments ---
    function loadStageFragment(targetSelector, url) {
      var el = document.querySelector(targetSelector);
      if (!el) return;
      // file:// 환경에서는 fetch가 차단되므로 iframe으로 로드
      if (location.protocol === 'file:') {
        el.innerHTML = '<iframe class="stage-iframe" id="stage-iframe" loading="lazy" title="스테이지 콘텐츠" src="' + url + '"></iframe>';
        // Parent-side: listen once for size messages
        if (!window.__stageIframeResizeHandler) {
          window.__stageIframeResizeHandler = function(e){
            var d = e && e.data;
            if (!d || d.type !== 'stage-iframe-size' || typeof d.height !== 'number') return;
            var iframe = document.getElementById('stage-iframe') || document.querySelector('#stageContent iframe.stage-iframe');
            if (!iframe) return;
            var newH = Math.max(50, Math.min(100000, Math.floor(d.height)));
            iframe.style.height = newH + 'px';
          };
          window.addEventListener('message', window.__stageIframeResizeHandler);
        }
        // After iframe loads, ping child to send its size
        var ifr = el.querySelector('iframe');
        if (ifr) {
          ifr.addEventListener('load', function(){
            try { ifr.contentWindow && ifr.contentWindow.postMessage({ type: 'stage-iframe-ping' }, '*'); } catch (_) { /* ignore */ }
          });
        }
        return;
      }
      try {
        fetch(url, { cache: 'no-store' })
          .then(function(resp){ if (!resp.ok) throw new Error('HTTP ' + resp.status); return resp.text(); })
          .then(function(html){ el.innerHTML = html; })
          .catch(function(){
            el.innerHTML = '<div class="hint">외부 파일(' + url + ')을 불러오지 못했습니다. 파일이 같은 폴더에 있는지 확인하거나, 로컬 서버로 열어주세요.</div>';
          });
      } catch (e) {
        el.innerHTML = '<div class="hint">브라우저 보안 정책으로 로컬 파일을 불러올 수 없습니다. ' + url + '을(를) 서버에서 제공하거나 수동으로 붙여넣어 주세요.</div>';
      }
    }

    // Per-callsign stage helpers
  var SESSION = { callsign: null };
  // localStorage helpers (fallback when cookies are blocked)
  function lsGet(key) { try { return window.localStorage.getItem(key); } catch (e) { return null; } }
  function lsSet(key, val) { try { window.localStorage.setItem(key, val); } catch (e) { /* ignore */ } }
  function lsRemove(key) { try { window.localStorage.removeItem(key); } catch (e) { /* ignore */ } }
    function stageCookieKey(callsign) {
      if (!callsign) return null;
      return 'stage_' + encodeURIComponent(String(callsign).toLowerCase());
    }
    function getCurrentCallsign() {
      return SESSION.callsign || getCookie('current_callsign') || lsGet('current_callsign') || getCookie('callsign') || lsGet('callsign');
    }
    function getStageForCallsign(callsign) {
      var key = stageCookieKey(callsign);
      if (!key) return null;
      var val = getCookie(key);
      if (val == null) {
        val = lsGet(key);
      }
      var stage = safeStageValue(val);
      if (stage) return stage;
      // Legacy migration: old cookie keys 'callsign' and 'stage'
      var legacyCall = getCookie('callsign') || lsGet('callsign');
      var legacyStage = safeStageValue(getCookie('stage') || lsGet('stage'));
      if (legacyCall && legacyStage && String(legacyCall).toLowerCase() === String(callsign).toLowerCase()) {
        // migrate
        setStageForCallsign(callsign, legacyStage);
        return legacyStage;
      }
      return null;
    }
    function setStageForCallsign(callsign, stage) {
      var key = stageCookieKey(callsign);
      if (!key) return;
      setCookie(key, String(stage), 30);
      lsSet(key, String(stage));
    }
    function eraseAllProgress() {
      var parts = document.cookie.split(';');
      for (var i = 0; i < parts.length; i++) {
        var kv = parts[i].trim();
        var eq = kv.indexOf('=');
        var name = eq >= 0 ? kv.substring(0, eq) : kv;
        if (name === 'current_callsign' || name.indexOf('stage_') === 0 || name === 'callsign' || name === 'stage') {
          eraseCookie(name);
        }
      }
      try {
        for (var i2 = window.localStorage.length - 1; i2 >= 0; i2--) {
          var k = window.localStorage.key(i2);
          if (!k) continue;
          if (k === 'current_callsign' || k === 'callsign' || k === 'stage' || k.indexOf('stage_') === 0) {
            window.localStorage.removeItem(k);
          }
        }
      } catch (e) { /* ignore */ }
    }

    function safeStageValue(val) {
      if (val === "complete") return "complete";
      var n = parseInt(val, 10);
      if (!isNaN(n) && n >= 1 && n <= 6) return n;
      return null;
    }

    function goStage(stage) {
      if (stage === "complete") return showComplete();
      if (stage >= 1 && stage <= 6) return showStage(stage);
      return showStage0(); // fallback
    }

    // --- Views ---
    function showStage0() {
      // Always start here; user provides callsign to resolve stage
  var savedCall = getCurrentCallsign() || "";

  // Update header image for Stage0
  updateStageHero(0);

      var $view = $('<div/>');
      $view.append('<h1>던전앤코파일럿3에 오신 것을 환영합니다.</h1>');
      $view.append('<p>이 프로그램은 코파일럿 게임으로, 코파일럿의 기능과 잠재력을 재미있고 유쾌한 방식으로 체험하도록 고안되었습니다.</p>');
      $view.append('<p>지금부터 GPT-5로 더욱 막강해진 코파일럿을 이용해 다양한 퀘스트를 수행하셔야 합니다. 본 게임은 주변동료와 다양한 경험과 의견을 나누며 즐겁게 플레이 해주세요.</p>');
      $view.append('<p>귀여운 캣파일럿과 함께 여섯 개의 퀘스트를 하나씩 건너며 나만의 식당을 디자인해보세요.</p>');
      $view.append('<p>시장 트렌드 탐색부터 데이터 분석, 창의적 기획까지—보드게임처럼 즐기는 실습형 여정이 여러분을 기다립니다.');
      $view.append(
       $('<div class="note" role="note" style="text-align: center;"></div>').html(
      '<img src="img/intro.png" alt="" style="max-width:60%; height:auto; border:1px solid #e5e7eb; border-radius:8px;" />'
         )
      );
      $view.append('<hr />');
      $view.append('<div class="status">퀘스트 0 • 콜사인(별명)을 입력해 시작하세요.</div>');
      $view.append('<label for="callsign">콜사인</label>');
      var $input = $('<input type="text" id="callsign" placeholder="본인을 식별할 수 있는 이름이면 무엇이든 좋습니다." />').val(savedCall);
      $view.append($input);
      $view.append('<div class="hint">입력 후 시작 버튼을 누르면 진행됩니다.</div>');

      var $row = $('<div class="row"></div>');
      var $btn = $('<button>시작</button>');
      $row.append($btn);

      var $reset = $('<button class="secondary" type="button">전체 초기화</button>').on('click', function() {
        eraseAllProgress();
        $('#app').empty(); showStage0();
      });
      $row.append($reset);

      $view.append($row);
      $view.append('<div class="error" id="err"></div>');
      $('#app').html($view);

      function start() {
        var cs = $input.val().trim();
        if (!cs) { $('#err').text('콜사인을 입력해 주세요.'); $input.focus(); return; }
        SESSION.callsign = cs; // keep in-memory for file:// where cookies may be blocked
        setCookie('current_callsign', cs, 30);
        lsSet('current_callsign', cs);
        var s = getStageForCallsign(cs);
        if (s) { goStage(s); return; }
        setStageForCallsign(cs, 1);
        showStage(1, cs);
      }
      $btn.on('click', start);
      $input.on('keydown', function(e) { if (e.key === 'Enter') start(); });
      $input.trigger('focus');
    }

    function showStage(n, callsign) {
      callsign = callsign || getCurrentCallsign();
      if (!callsign) { showStage0(); return; }
      setStageForCallsign(callsign, n); // ensure cookie reflects current stage for this callsign

  // Update header image for current stage
      updateStageHero(n);

      var $view = $('<div/>');
      $view.append(
        $('<div class="status"></div>').html(
          '현재 단계: <strong>퀘스트 ' + n + '</strong> · 콜사인: <span class="badge">' + $('<div>').text(callsign).html() + '</span>'
        )
      );
      $view.append('<hr/>');
      if (n >= 1 && n <= 6) {
        // Placeholder for external content of this stage
        $view.append('<div id="stageContent" class="panel"></div>');
      }
      $view.append('<hr/>');
      $view.append('<div class="spacer"></div>');
      $view.append('<div>이번 퀘스트를 완료하였으면 다음 버튼을 눌러주세요.</div>');
      $view.append('<div class="spacer"></div>');
      //$view.append('<label for="keycode">암호</label>');
      //var $input = $('<input type="text" id="keycode" inputmode="numeric" autocomplete="off" placeholder="" />');
      //$view.append($input);

      var $row = $('<div class="row"></div>');
      var $submit = $('<button>다음</button>');
      var $reset = $('<button class="secondary" type="button">콜사인 변경</button>').on('click', function() {
        // Just forget current_callsign; keep stored per-callsign progress
        SESSION.callsign = null;
        eraseCookie('current_callsign');
        lsRemove('current_callsign');
        $('#app').empty(); showStage0();
      });
      $row.append($submit).append($reset);
      $view.append($row);

      $view.append('<div class="error" id="err"></div>');
      $('#app').html($view);

      // After mounting, load external HTML for current stage
      if (n >= 1 && n <= 6) {
        loadStageFragment('#stageContent', 'stage' + n + '.html');
      }

      function verify() {
        //var v = ($input.val() || '').trim();
        //if (!v) { $('#err').text('다음 단계로 넘어가려면 암호 입력'); $input.focus(); return; }
        //if (v === KEYCODES[n]) {
          if (n < 6) {
            var next = n + 1;
            setStageForCallsign(callsign, next);
            showStage(next, callsign);
          } else {
            setStageForCallsign(callsign, 'complete');
            showComplete(callsign);
          }
        //} else {
        //  $('#err').text('암호가 올바르지 않습니다.');
        //  $input.select().focus();
        //}
      }
      $submit.on('click', verify);
      $input.on('keydown', function(e) { if (e.key === 'Enter') verify(); });
      $input.trigger('focus');
    }

    function showComplete(callsign) {
      callsign = callsign || getCurrentCallsign() || '(미지정)';
  // Update header image for completion
  updateStageHero('complete');
      var $view = $('<div/>');
      $view.append('<div class="status">- The End - </div>');
      $view.append('<hr />');
      $view.append(
        $('<div class="success"></div>').html(
          '축하합니다, <span class="badge">' + $('<div>').text(callsign).html() + '</span> 님! 모든 퀘스트를 완료하였습니다.<br />Copilot과 함께한 여정이 즐거웠기를 바랍니다.<br /><br />'
        )
      );
      $view.append(
       $('<div class="note" role="note" style="text-align: center;"></div>').html(
      '<img src="img/end.png" alt="" style="max-width:60%; height:auto; border:1px solid #e5e7eb; border-radius:8px;" />'
         )
      );
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?viewid=c642ba25%2D816b%2D4381%2Daa73%2Db495fb1eea34&startedResponseCatch=true\',\'_blank\',\'noopener\')">채널 저장소</button><br />');
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2F%2Dtest1%2FShared%20Documents%2FStage1&viewid=aeb30331%2D35ad%2D4039%2Db718%2D63a2f3a40a5f&startedResponseCatch=true\',\'_blank\',\'noopener\')">Stage1 이미지갤러리</button>&nbsp;&nbsp;');
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2F%2Dtest1%2FShared%20Documents%2FStage2&viewid=aeb30331%2D35ad%2D4039%2Db718%2D63a2f3a40a5f&startedResponseCatch=true\',\'_blank\',\'noopener\')">Stage2 이미지갤러리</button>&nbsp;&nbsp;');
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2F%2Dtest1%2FShared%20Documents%2FStage3&viewid=aeb30331%2D35ad%2D4039%2Db718%2D63a2f3a40a5f&startedResponseCatch=true\',\'_blank\',\'noopener\')">Stage3 이미지갤러리</button>&nbsp;&nbsp;');
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2F%2Dtest1%2FShared%20Documents%2FStage4&viewid=aeb30331%2D35ad%2D4039%2Db718%2D63a2f3a40a5f&startedResponseCatch=true\',\'_blank\',\'noopener\')">Stage4 이미지갤러리</button>&nbsp;&nbsp;');
      // $view.append('<button type="button" onclick="window.open(\'https://microsoftapc.sharepoint.com/teams/-test1/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2F%2Dtest1%2FShared%20Documents%2FStage5&viewid=aeb30331%2D35ad%2D4039%2Db718%2D63a2f3a40a5f&startedResponseCatch=true\',\'_blank\',\'noopener\')">Stage5 이미지갤러리</button>&nbsp;&nbsp;');
      $view.append('<hr />');
      var $row = $('<div class="row"></div>');
      var $restart = $('<button class="secondary" type="button">처음으로</button>').on('click', function() {
        if (callsign && callsign !== '(미지정)') {
          setStageForCallsign(callsign, 1);
        }
        SESSION.callsign = null;
        eraseCookie('current_callsign');
        lsRemove('current_callsign');
        showStage0();
      });
      var $reset = $('<button type="button">완전 초기화</button>').on('click', function() {
        eraseAllProgress();
        showStage0();
      });
      $row.append($restart).append($reset);
      $view.append($row);
      $('#app').html($view);
    }

    // --- Bootstrap (no $ dependency until ensured) ---
    document.addEventListener('DOMContentLoaded', function(){
      ensureJQuery(function(){
        // 성공적으로 jQuery가 준비됨
        showStage0();
      }, function(){
        var el = document.getElementById('app');
        if (el) {
          el.innerHTML = '<div class="error">jQuery를 불러오지 못했습니다. 네트워크 연결을 확인하거나 인터넷이 가능한 환경에서 다시 열어주세요.</div>';
        }
      });
    });
  </script>
  <div class="vibe">
  	<details class="fold">
			<summary> 이 앱은 깃헙코파일럿을 이용해 바이브코딩으로 만들어졌습니다.</summary>
			<div class="fold-body">
				<img src="img/image copy 7.png" alt="" style="max-width:100%; height:auto; border:1px solid #e5e7eb; border-radius:8px;" />
			</div>
		</details>
  </div>
</body>
</html>